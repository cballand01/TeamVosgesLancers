<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Suivi d’entraînement — Semaine & Jour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --surface:#0b1326;
      --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --accent:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    a{color:inherit}
    .wrap{max-width:740px;margin:0 auto;padding:14px 14px calc(90px + env(safe-area-inset-bottom,0))}
    @supports(padding:max(0px)){ .wrap{ padding-left:max(14px,env(safe-area-inset-left)); padding-right:max(14px,env(safe-area-inset-right)); } }

    /* header */
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--text);text-decoration:none;font-size:16px;margin-bottom:10px}
    .back svg{width:20px;height:20px;stroke:#fff}
    h1{margin:0 0 4px;font-size:22px;font-weight:800;position:relative;padding-bottom:8px;line-height:1.2}
    h1::after{content:"";position:absolute;left:0;bottom:0;width:70px;height:3px;background:var(--accent);border-radius:999px}
    .subtitle{opacity:.85;color:var(--muted);margin:6px 0 12px;font-size:14px}

    /* tabs */
    .tabs{display:flex;gap:8px;align-items:center;margin:10px 0 12px}
    .tab{border:1px solid var(--line);background:#0b1326;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:13px}
    .tab.active{background:var(--accent);color:#0b1a10;border-color:var(--accent);font-weight:700}
    .spacer{flex:1}
    .btn{border:1px solid var(--line);background:#0b1326;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#0b1326;border-color:var(--accent);font-weight:700}
    .btn.danger{border-color:var(--danger);color:var(--danger)}
    .btn.ghost{background:transparent}

    /* week header */
    .week-head{display:flex;align-items:center;gap:8px;margin:6px 0 10px}
    .week-title{font-weight:800;font-size:15px}

    /* day cards (week view) */
    .days{display:grid;gap:10px}
    .day-card{
      position:relative;display:flex;gap:10px;align-items:flex-start;
      background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;
    }
    .day-card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:var(--accent);border-radius:12px 0 0 12px}
    .date-col{display:flex;flex-direction:column;gap:2px;min-width:64px}
    .dow{font-size:12px;color:var(--muted);text-transform:capitalize}
    .dnum{font-weight:800}
    .list-col{flex:1;min-width:0;display:flex;flex-direction:column;gap:6px}
    .chip{
      display:flex;align-items:center;gap:6px;
      background:#0b1326;border:1px solid #243043;border-radius:10px;padding:6px 8px;
      font-size:12px;overflow:hidden
    }
    .chip .txt{min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini{font-size:11px;color:#cbd5e1;opacity:.85;margin-left:6px}
    .add{margin-left:auto;border:1px solid var(--line);background:transparent;color:var(--text);
      padding:6px 10px;border-radius:10px;cursor:pointer;flex-shrink:0}

    /* day view */
    .day-wrap{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    .day-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .day-title{font-size:18px;font-weight:800;text-transform:capitalize}
    .day-list{display:grid;gap:8px}
    .row{background:#0b1326;border:1px solid #243043;border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .row .name{font-weight:700}
    .row .meta{font-size:12px;color:var(--muted);margin-top:2px}
    .row .act{display:flex;gap:6px}
    .badge{border:1px solid #334155;border-radius:999px;padding:1px 8px;font-size:11px;color:#cbd5e1;margin-left:6px}
    .empty{font-size:14px;color:var(--muted);padding:8px 2px}

    /* bottom sheet (add) */
    .sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:flex-end;z-index:50}
    .sheet{
      width:100%;max-width:740px;margin:0 auto;background:var(--card);border:1px solid var(--line);
      border-bottom:none;border-top-left-radius:16px;border-top-right-radius:16px;
      padding:12px 14px 14px;max-height:85vh;overflow:auto;animation:slideup .18s ease-out
    }
    @keyframes slideup{from{transform:translateY(12px);opacity:.3}to{transform:translateY(0);opacity:1}}
    .rowf{display:flex;gap:8px;align-items:center;margin:8px 0}
    .rowf label{flex:0 0 120px;opacity:.9}
    .rowf input,.rowf select,.rowf textarea{flex:1;background:#0b1326;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:10px}
    .sheet .actions{display:flex;gap:8px;margin-top:2px}
    .hint{font-size:12px;color:var(--muted)}

    @media (min-width:480px){
      h1{font-size:24px}
      .week-title{font-size:16px}
      .day-title{font-size:20px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="index.html" class="back">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
      Retour
    </a>

    <h1>Suivi d’entraînement</h1>
    <div class="subtitle">Vue semaine (par défaut) ou jour • Ajoute depuis chaque jour</div>

    <div class="tabs">
      <button id="tabWeek" class="tab active">Semaine</button>
      <button id="tabDay" class="tab">Jour</button>
      <div class="spacer"></div>
      <button id="btnToday" class="btn ghost">Aujourd’hui</button>
    </div>

    <!-- === Vue Semaine === -->
    <div id="viewWeek">
      <div class="week-head">
        <button id="prevWeek" class="btn">◀</button>
        <div id="weekTitle" class="week-title"></div>
        <button id="nextWeek" class="btn">▶</button>
        <div class="spacer"></div>
      </div>

      <div id="weekDays" class="days"></div>
    </div>

    <!-- === Vue Jour === -->
    <div id="viewDay" style="display:none">
      <div class="day-wrap">
        <div class="day-head">
          <button id="prevDay" class="btn">◀</button>
          <div id="dayTitle" class="day-title"></div>
          <button id="nextDay" class="btn">▶</button>
          <div class="spacer"></div>
          <button id="addDay" class="btn primary">＋ Ajouter</button>
        </div>
        <div id="dayList" class="day-list"></div>
      </div>
    </div>
  </div>

  <!-- === Bottom sheet: Ajouter une entrée === -->
  <div id="sheetBg" class="sheet-bg">
    <div class="sheet">
      <h3 style="margin:4px 0 10px">Ajouter une séance</h3>

      <div class="rowf">
        <label for="fDate">Date</label>
        <input id="fDate" type="date">
      </div>

      <div class="rowf">
        <label for="fName">Exercice</label>
        <input id="fName" placeholder="ex: Développé couché, Stand throw…" />
      </div>

      <div class="rowf">
        <label for="fMode">Type de mesure</label>
        <select id="fMode">
          <option value="reps">Répétitions</option>
          <option value="sets_reps">Séries × Répétitions</option>
          <option value="duration">Durée</option>
          <option value="weight">Poids (Kg) uniquement</option>
        </select>
      </div>

      <div class="rowf" data-field="reps">
        <label for="fReps">Répétitions</label>
        <input id="fReps" type="number" inputmode="numeric" min="0" placeholder="ex: 12" />
      </div>

      <div class="rowf" data-field="sets_reps" style="display:none">
        <label>Séries × Rép</label>
        <input id="fSets" type="number" inputmode="numeric" min="0" placeholder="Séries (ex: 4)" style="max-width:140px">
        <input id="fSRReps" type="number" inputmode="numeric" min="0" placeholder="Rép (ex: 6)" style="max-width:140px">
      </div>

      <div class="rowf" data-field="duration" style="display:none">
        <label>Durée</label>
        <input id="fMin" type="number" inputmode="numeric" min="0" placeholder="Minutes" style="max-width:140px">
        <input id="fSec" type="number" inputmode="numeric" min="0" max="59" placeholder="Secondes" style="max-width:140px">
      </div>

      <div class="rowf">
        <label for="fKg">Kg (optionnel)</label>
        <input id="fKg" type="number" inputmode="decimal" step="0.5" placeholder="ex: 60" />
      </div>

      <div class="rowf">
        <label for="fNotes">Commentaires</label>
        <textarea id="fNotes" rows="3" placeholder="Sensations, technique, contexte…"></textarea>
      </div>

      <div class="actions">
        <button id="btnCancel" class="btn ghost">Annuler</button>
        <button id="btnSave" class="btn primary">Enregistrer</button>
      </div>
      <div id="msg" class="hint" style="margin-top:6px"></div>
    </div>
  </div>

  <script>
    /* ===== Utils ===== */
    const $=(q,root=document)=>root.querySelector(q);
    const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
    const pad=n=>String(n).padStart(2,'0');
    const toISO=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const fromISO=s=>{const[a,b,c]=s.split('-').map(Number);return new Date(a,b-1,c);};
    const monthsFR=['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];
    const dowsFR=['lundi','mardi','mercredi','jeudi','vendredi','samedi','dimanche'];

    /* ===== Store ===== */
    const STORAGE_KEY='trainingLog.v1';
    function loadStore(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch{return[];} }
    function saveStore(a){ localStorage.setItem(STORAGE_KEY,JSON.stringify(a)); }
    let DATA=loadStore(); // {id,date,name,mode,reps,sets,srreps,min,sec,kg,notes,_ts}

    /* ===== State ===== */
    let refDate=new Date(); // sert de référence à la semaine affichée
    let selDayISO=toISO(new Date());

    /* ===== Tabs ===== */
    const tabWeek=$('#tabWeek'), tabDay=$('#tabDay');
    const viewWeek=$('#viewWeek'), viewDay=$('#viewDay');
    function goWeek(){ tabWeek.classList.add('active'); tabDay.classList.remove('active'); viewWeek.style.display='block'; viewDay.style.display='none'; renderWeek(); }
    function goDay(dateISO){ if(dateISO) selDayISO=dateISO; tabDay.classList.add('active'); tabWeek.classList.remove('active'); viewDay.style.display='block'; viewWeek.style.display='none'; renderDay(); }
    tabWeek.onclick=goWeek;
    tabDay.onclick=()=>goDay(selDayISO);
    $('#btnToday').onclick=()=>{ const now=new Date(); refDate=now; selDayISO=toISO(now); goDay(selDayISO); };

    /* ===== Week helpers ===== */
    function startOfWeek(d){ // lundi
      const x=new Date(d.getFullYear(),d.getMonth(),d.getDate());
      const day=(x.getDay()+6)%7; // 0=lundi…6=dim
      x.setDate(x.getDate()-day);
      return x;
    }
    function endOfWeek(d){const s=startOfWeek(d); const e=new Date(s); e.setDate(s.getDate()+6); return e;}

    /* ===== Week view ===== */
    $('#prevWeek').onclick=()=>{ refDate.setDate(refDate.getDate()-7); renderWeek(); };
    $('#nextWeek').onclick=()=>{ refDate.setDate(refDate.getDate()+7); renderWeek(); };

    function renderWeek(){
      const s=startOfWeek(refDate), e=endOfWeek(refDate);
      $('#weekTitle').textContent=`Semaine du ${s.getDate()} ${monthsFR[s.getMonth()]} au ${e.getDate()} ${monthsFR[e.getMonth()]} ${e.getFullYear()}`;
      const root=$('#weekDays'); root.innerHTML='';
      for(let i=0;i<7;i++){
        const d=new Date(s); d.setDate(s.getDate()+i);
        const iso=toISO(d);
        const card=document.createElement('div'); card.className='day-card';

        const dateCol=document.createElement('div'); dateCol.className='date-col';
        const dow=document.createElement('div'); dow.className='dow'; dow.textContent=dowsFR[i];
        const dnum=document.createElement('div'); dnum.className='dnum'; dnum.textContent=`${pad(d.getDate())}/${pad(d.getMonth()+1)}`;
        dateCol.append(dow,dnum);

        const listCol=document.createElement('div'); listCol.className='list-col';
        const list=DATA.filter(x=>x.date===iso).sort((a,b)=>(a._ts||0)-(b._ts||0));
        if(list.length===0){
          const empty=document.createElement('div'); empty.className='mini'; empty.textContent='Aucune séance.';
          listCol.appendChild(empty);
        }else{
          list.slice(0,4).forEach(e=>{
            const chip=document.createElement('div'); chip.className='chip';
            const txt=document.createElement('div'); txt.className='txt'; txt.textContent=formatLine(e);
            chip.appendChild(txt);
            listCol.appendChild(chip);
          });
          if(list.length>4){
            const more=document.createElement('div'); more.className='mini'; more.textContent=`+${list.length-4} autre(s)…`;
            listCol.appendChild(more);
          }
        }

        const add=document.createElement('button'); add.className='add'; add.textContent='＋'; add.onclick=()=>openSheet(iso);

        card.append(dateCol,listCol,add);
        // toucher la carte → bascule en vue jour
        card.addEventListener('click',ev=>{ if(ev.target===add) return; goDay(iso); });
        root.appendChild(card);
      }
    }

    /* ===== Day view ===== */
    $('#prevDay').onclick=()=>{ const d=fromISO(selDayISO); d.setDate(d.getDate()-1); selDayISO=toISO(d); renderDay(); };
    $('#nextDay').onclick=()=>{ const d=fromISO(selDayISO); d.setDate(d.getDate()+1); selDayISO=toISO(d); renderDay(); };
    $('#addDay').onclick=()=>openSheet(selDayISO);

    function renderDay(){
      const d=fromISO(selDayISO);
      $('#dayTitle').textContent=d.toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      const root=$('#dayList'); root.innerHTML='';
      const arr=DATA.filter(x=>x.date===selDayISO).sort((a,b)=>(a._ts||0)-(b._ts||0));
      if(arr.length===0){ root.innerHTML='<div class="empty">Aucune séance ce jour.</div>'; return; }

      arr.forEach(e=>{
        const row=document.createElement('div'); row.className='row';
        const left=document.createElement('div');
        const name=document.createElement('div'); name.className='name';
        name.innerHTML=`${escapeHtml(e.name)} <span class="badge">${modeLabel(e)}</span>`;
        const meta=document.createElement('div'); meta.className='meta'; meta.textContent=entryDetails(e);
        if(e.notes){ const com=document.createElement('div'); com.className='meta'; com.textContent='💬 '+e.notes; left.append(name,meta,com); }
        else { left.append(name,meta); }

        const act=document.createElement('div'); act.className='act';
        const del=document.createElement('button'); del.className='btn danger'; del.textContent='Supprimer';
        del.onclick=()=>{ if(confirm('Supprimer cette entrée ?')){ DATA=DATA.filter(x=>x.id!==e.id); saveStore(DATA); renderDay(); renderWeek(); } };
        act.appendChild(del);

        row.append(left,act);
        root.appendChild(row);
      });
    }

    function modeLabel(e){
      switch(e.mode){
        case 'reps': return 'Répétitions';
        case 'sets_reps': return 'Séries×Rép';
        case 'duration': return 'Durée';
        case 'weight': return 'Poids';
        default: return '—';
      }
    }
    function entryDetails(e){
      let parts=[];
      if(e.mode==='reps' && e.reps!=null) parts.push(`${e.reps} rép`);
      if(e.mode==='sets_reps' && (e.sets!=null || e.srreps!=null)) parts.push(`${e.sets||0}×${e.srreps||0}`);
      if(e.mode==='duration' && (e.min!=null || e.sec!=null)) parts.push(`${e.min||0}′${pad(e.sec||0)}″`);
      if(e.mode==='weight' && e.kg!=null) parts.push(`${e.kg} kg`);
      if(e.mode!=='weight' && e.kg!=null) parts.push(`${e.kg} kg`);
      return parts.join(' • ');
    }
    function formatLine(e){
      const det=entryDetails(e);
      return det? `${e.name} — ${det}` : e.name;
    }
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c]));}

    /* ===== Sheet ===== */
    const sheetBg=$('#sheetBg');
    const fDate=$('#fDate'), fName=$('#fName'), fMode=$('#fMode');
    const fReps=$('#fReps'), fSets=$('#fSets'), fSRReps=$('#fSRReps');
    const fMin=$('#fMin'), fSec=$('#fSec'), fKg=$('#fKg'), fNotes=$('#fNotes');

    function openSheet(dateISO){
      $('#msg').textContent='';
      fDate.value=dateISO||toISO(new Date());
      fName.value=''; fMode.value='reps';
      fReps.value=''; fSets.value=''; fSRReps.value='';
      fMin.value=''; fSec.value=''; fKg.value=''; fNotes.value='';
      updateModeFields();
      sheetBg.style.display='flex';
    }
    function closeSheet(){ sheetBg.style.display='none'; }
    $('#btnCancel').onclick=closeSheet;
    sheetBg.addEventListener('click',e=>{ if(e.target===sheetBg) closeSheet(); });
    $('#fMode').addEventListener('change',updateModeFields);

    function updateModeFields(){
      $$('[data-field]').forEach(el=>el.style.display='none');
      const m=fMode.value;
      if(m==='reps') $('[data-field="reps"]').style.display='';
      if(m==='sets_reps') $('[data-field="sets_reps"]').style.display='';
      if(m==='duration') $('[data-field="duration"]').style.display='';
    }

    function numOrNull(v, float=false){ if(v==null||v==='') return null; const n=float?parseFloat(v):parseInt(v,10); return isNaN(n)?null:n; }

    $('#btnSave').onclick=()=>{
      const item={
        id:'e_'+Date.now()+'_'+Math.random().toString(36).slice(2,7),
        _ts:Date.now(),
        date:fDate.value,
        name:fName.value.trim(),
        mode:fMode.value,
        reps:numOrNull(fReps.value),
        sets:numOrNull(fSets?.value),
        srreps:numOrNull(fSRReps?.value),
        min:numOrNull(fMin?.value),
        sec:numOrNull(fSec?.value),
        kg:numOrNull(fKg?.value,true),
        notes:fNotes.value.trim()
      };
      if(!item.date){ $('#msg').textContent='La date est obligatoire.'; return; }
      if(!item.name){ $('#msg').textContent='Le nom de l’exercice est obligatoire.'; return; }
      if(item.mode==='weight' && item.kg==null){ $('#msg').textContent='Indique un poids (kg).'; return; }

      // nettoyage champs non utilisés
      if(item.mode!=='reps') item.reps=null;
      if(item.mode!=='sets_reps'){ item.sets=null; item.srreps=null; }
      if(item.mode!=='duration'){ item.min=null; item.sec=null; }

      DATA.push(item); saveStore(DATA); closeSheet();
      // refresh la vue visible
      if(viewDay.style.display!=='none'){ renderDay(); } else { renderWeek(); }
    };

    /* ===== Boot ===== */
    (function init(){
      const now=new Date();
      refDate=now; selDayISO=toISO(now);
      renderWeek();
    })();
  </script>
</body>
</html>
