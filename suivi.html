<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Suivi — Semaine d’entraînement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --accent:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px 16px 96px}

    .topbar{display:flex;align-items:center;margin-bottom:12px}
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--text);text-decoration:none;font-size:16px}
    .back svg{width:20px;height:20px;stroke:#fff}

    .page-header h1{font-size:28px;font-weight:700;margin:0 0 4px;position:relative;padding-bottom:6px}
    .page-header h1::after{content:"";position:absolute;left:0;bottom:0;width:72px;height:3px;background:var(--accent);border-radius:999px}
    .page-header .subtitle{opacity:.8;font-size:16px;margin:0 0 16px}

    .weekbar{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
    .navbtn{
      width:36px;height:36px;border-radius:50%;border:1px solid var(--line);
      background:var(--card);color:var(--text);display:grid;place-items:center;
      font-size:18px;cursor:pointer;transition:border-color .2s,transform .1s
    }
    .navbtn:hover{border-color:var(--accent);transform:translateY(-1px)}
    .when{font-weight:600;font-size:15px;min-width:190px;text-align:center}

    .days{display:flex;gap:8px;overflow-x:auto;padding:6px 0 10px;margin-bottom:14px;scroll-behavior:smooth}
    .daypill{
      flex:0 0 auto;min-width:72px;text-align:center;padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);background:#0b1326;color:#fff;cursor:pointer;font-weight:500
    }
    .daypill small{display:block;opacity:.7}
    .daypill.active{background:var(--accent);color:#0b1326;border-color:var(--accent);font-weight:700}

    .list{display:grid;gap:10px}
    .empty{font-size:14px;color:var(--muted);opacity:.9;padding:6px}

    .card{
      position:relative;display:flex;gap:10px;align-items:stretch;background:var(--card);border:1px solid var(--line);
      border-radius:12px;padding:10px;overflow:hidden
    }
    .card .bar{width:6px;border-radius:8px;background:var(--accent);flex:0 0 6px}
    .card .info{flex:1;min-width:0}
    .title{font-weight:800;margin-bottom:4px}
    .meta{font-size:13px;color:var(--muted)}
    .rows{margin-top:6px;display:grid;gap:4px}
    .rowline{font-size:13px}
    .del{position:absolute;top:6px;right:8px;border:none;background:transparent;color:#94a3b8;cursor:pointer;font-size:18px}
    .del:hover{color:#fff}

    .fab{
      position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;
      display:grid;place-items:center;background:var(--accent);color:#0b1326;
      border:1px solid #1a2b1f;box-shadow:0 10px 30px rgba(0,0,0,.4);cursor:pointer;z-index:50;
      font-size:28px;font-weight:900
    }

    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:flex-end;z-index:60}
    .sheet{
      width:100%;max-width:960px;margin:0 auto;background:var(--card);
      border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
      border-bottom:none;padding:12px 16px 16px;animation:slideup .18s ease-out;max-height:88vh;overflow:auto
    }
    @keyframes slideup{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}

    .row{display:flex;gap:8px;margin:8px 0;align-items:center}
    .row label{flex:0 0 110px;opacity:.9}
    .row input,.row select,.row textarea{
      flex:1;background:#0b1326;border:1px solid var(--line);border-radius:8px;color:#e5e7eb;padding:10px
    }
    .row textarea{resize:vertical}

    .grid{display:grid;gap:6px}
    .mini-header{display:grid;grid-template-columns:64px 64px 64px 36px;gap:6px;align-items:center}
    .mini-row{display:grid;grid-template-columns:64px 64px 64px 36px;gap:6px;align-items:center}
    .mini-sets,.mini-reps,.mini-kg,.mini-min,.mini-sec{
      width:100%;height:40px;text-align:center;
      background:#0b1326;border:1px solid var(--line);border-radius:8px;color:#e5e7eb;
      font-size:14px;appearance:textfield;
    }
    .mini-label{font-size:12px;color:#94a3b8;text-align:center}

    /* Boutons + / - mis en couleurs */
    .iconbtn{
      width:36px;height:36px;border-radius:10px;border:1px solid var(--line);
      background:#0b1326;color:#e5e7eb;display:grid;place-items:center;cursor:pointer;
      transition:all .15s ease;
    }
    .iconbtn.add{background:var(--accent);color:#0b1326;border-color:#16a34a;font-weight:900}
    .iconbtn.remove{background:var(--danger);color:#fff;border-color:#b91c1c;font-weight:900}
    .iconbtn:active{transform:scale(.94)}

    .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:10px}
    .btn{border:1px solid var(--line);border-radius:10px;background:#0b1326;color:#e5e7eb;padding:10px 12px;cursor:pointer}
    .btn.ghost{background:transparent}
    .small{font-size:12px;color:#94a3b8}
    .mode-block{display:none}
    .mode-block.active{display:block}

    @media (max-width:380px){
      .mini-header,.mini-row{grid-template-columns:56px 56px 56px 36px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a href="index.html" class="back">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Retour
      </a>
    </div>

    <header class="page-header">
      <h1>Suivi d’entraînement</h1>
      <div class="subtitle">Vue semaine • Ajoute tes exos par jour</div>
    </header>

    <div class="weekbar">
      <button class="navbtn" id="prev">‹</button>
      <div class="when" id="when"></div>
      <button class="navbtn" id="today">⌂</button>
      <button class="navbtn" id="next">›</button>
    </div>

    <div class="days" id="days"></div>
    <div class="list" id="list"></div>
    <button class="fab" id="fab" title="Ajouter">＋</button>

    <!-- Bottom sheet -->
    <div class="sheet-backdrop" id="sheetBg">
      <div class="sheet">
        <h3 style="margin:4px 0 8px">Ajouter un exercice</h3>

        <div class="row"><label>Date</label><input id="fDate" type="date"></div>
        <div class="row"><label>Nom</label><input id="fName" type="text" placeholder="ex: Développé couché"></div>
        <div class="row">
          <label>Mode</label>
          <select id="fMode">
            <option value="sets_reps_kg">Séries × Rép + Kg</option>
            <option value="sets_reps">Séries × Rép</option>
            <option value="reps">Répétitions</option>
            <option value="time">Durée</option>
            <option value="weight_only">Kg seul</option>
          </select>
        </div>

        <!-- Séries × Rép + Kg -->
        <div id="blkSRK" class="mode-block">
          <div class="mini-header">
            <div class="mini-label">Séries</div><div class="mini-label">Rép</div><div class="mini-label">Kg</div><div></div>
          </div>
          <div id="rowsSRK" class="grid"></div>
          <div style="margin-top:6px"><button class="iconbtn add" id="addRowSRK">＋</button></div>
        </div>

        <!-- Séries × Rép -->
        <div id="blkSR" class="mode-block">
          <div class="mini-header">
            <div class="mini-label">Séries</div><div class="mini-label">Rép</div><div></div><div></div>
          </div>
          <div id="rowsSR" class="grid"></div>
          <div style="margin-top:6px"><button class="iconbtn add" id="addRowSR">＋</button></div>
        </div>

        <!-- Répétitions -->
        <div id="blkR" class="mode-block">
          <div class="mini-header"><div class="mini-label" style="grid-column:1/4">Répétitions</div></div>
          <div id="rowsR" class="grid"></div>
          <div style="margin-top:6px"><button class="iconbtn add" id="addRowR">＋</button></div>
        </div>

        <!-- Durée -->
        <div id="blkT" class="mode-block">
          <div class="mini-header"><div class="mini-label">Min</div><div class="mini-label">Sec</div><div></div><div></div></div>
          <div id="rowsT" class="grid"></div>
          <div style="margin-top:6px"><button class="iconbtn add" id="addRowT">＋</button></div>
        </div>

        <!-- Kg seul -->
        <div id="blkW" class="mode-block">
          <div class="mini-header"><div class="mini-label" style="grid-column:1/3">Kg</div><div></div><div></div></div>
          <div id="rowsW" class="grid"></div>
          <div style="margin-top:6px"><button class="iconbtn add" id="addRowW">＋</button></div>
        </div>

        <div class="row"><label>Commentaire</label><textarea id="fNote" rows="3" placeholder="Notes, sensations…"></textarea></div>
        <div class="actions"><button class="btn ghost" id="cancel">Annuler</button><button class="btn" id="save">Ajouter</button></div>
        <div id="msg" class="small" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <script>
    /***** SEMAINE *****/
    const daysEl = document.getElementById("days");
    const listEl = document.getElementById("list");
    const whenEl = document.getElementById("when");
    const sheetBg = document.getElementById("sheetBg");

    const fDate = document.getElementById("fDate");
    const fName = document.getElementById("fName");
    const fMode = document.getElementById("fMode");
    const fNote = document.getElementById("fNote");

    const rowsSRK = document.getElementById("rowsSRK");
    const rowsSR  = document.getElementById("rowsSR");
    const rowsR   = document.getElementById("rowsR");
    const rowsT   = document.getElementById("rowsT");
    const rowsW   = document.getElementById("rowsW");

    let currentMonday = getMonday(new Date());
    let selectedDate = new Date();
    let items = []; // {id, date, name, mode, rows[], note, lines[]}

    function getMonday(d){
      d = new Date(d);
      const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }
    function formatDate(d){
      const d2 = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      return d2.toISOString().split("T")[0];
    }

    function renderWeek(){
      daysEl.innerHTML = "";
      const pills = [];
      for(let i=0;i<7;i++){
        const day = new Date(currentMonday);
        day.setDate(day.getDate()+i);
        const pill = document.createElement("div");
        pill.className = "daypill";
        pill.dataset.date = formatDate(day);
        pill.innerHTML = `${day.toLocaleDateString("fr-FR",{weekday:"short"})}<small>${day.getDate()} ${day.toLocaleDateString("fr-FR",{month:"short"})}</small>`;
        pill.onclick = () => {
          selectedDate = new Date(day);
          fDate.value = formatDate(selectedDate);
          highlightSelected(pill.dataset.date);
          renderList();
          pill.scrollIntoView({ inline:"center", behavior:"smooth", block:"nearest" });
        };
        daysEl.appendChild(pill);
        pills.push(pill);
      }
      const end = new Date(currentMonday);
      end.setDate(end.getDate()+6);
      whenEl.textContent = `${currentMonday.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})} – ${end.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}`;

      highlightSelected(formatDate(selectedDate));
      const today = formatDate(new Date());
      const todayPill = pills.find(p=>p.dataset.date===today);
      if(todayPill) setTimeout(()=>todayPill.scrollIntoView({inline:"center",behavior:"smooth"}), 50);
    }

    function highlightSelected(dateStr){
      document.querySelectorAll(".daypill").forEach(p=>p.classList.remove("active"));
      const target = Array.from(document.querySelectorAll(".daypill")).find(p=>p.dataset.date===dateStr);
      if(target) target.classList.add("active");
    }

    /***** AFFICHAGE LISTE *****/
    function renderList(){
      const dateStr = formatDate(selectedDate);
      const todays = items.filter(e=>e.date===dateStr);
      listEl.innerHTML = "";
      if(todays.length===0){
        listEl.innerHTML = `<div class="empty">Aucun exercice</div>`;
        return;
      }
      todays.forEach(e=>{
        const card = document.createElement("div");
        card.className = "card";
        const lines = e.lines && e.lines.length ? e.lines : [];
        card.innerHTML = `
          <div class="bar"></div>
          <div class="info">
            <div class="title">${escapeHtml(e.name || 'Exercice')}</div>
            <div class="meta">${formatFrenchDate(e.date)}</div>
            <div class="rows">
              ${lines.map(l=>`<div class="rowline">${escapeHtml(l)}</div>`).join('')}
              ${e.note ? `<div class="rowline" style="opacity:.8">${escapeHtml(e.note)}</div>`:''}
            </div>
          </div>
          <button class="del" title="Supprimer">×</button>
        `;
        card.querySelector(".del").onclick = () => {
          if(!confirm("Supprimer cet exercice ?")) return;
          items = items.filter(x=>x.id!==e.id);
          renderList();
        };
        listEl.appendChild(card);
      });
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
    function formatFrenchDate(iso){
      const d = isoToDate(iso);
      return d.toLocaleDateString('fr-FR',{weekday:'short', day:'2-digit', month:'short'});
    }
    function isoToDate(s){const p=s.split('-');return new Date(+p[0],p[1]-1,+p[2]);}

    /***** MODALE AJOUT *****/
    const modeBlocks = {
      sets_reps_kg: document.getElementById('blkSRK'),
      sets_reps:    document.getElementById('blkSR'),
      reps:         document.getElementById('blkR'),
      time:         document.getElementById('blkT'),
      weight_only:  document.getElementById('blkW'),
    };

    function showModeBlock(mode){
      Object.values(modeBlocks).forEach(el=>el.classList.remove('active'));
      (modeBlocks[mode]||modeBlocks.sets_reps_kg).classList.add('active');
    }

    fMode.addEventListener('change',()=>showModeBlock(fMode.value));

    // Ajout / suppression de mini-lignes
    function addRow(container, fields){
      const row = document.createElement('div');
      row.className = 'mini-row';
      row.innerHTML = `
        ${fields.sets?`<input class="mini-sets" type="number" min="0" inputmode="numeric" placeholder="">`:''}
        ${fields.reps?`<input class="mini-reps" type="number" min="0" inputmode="numeric" placeholder="">`:''}
        ${fields.kg?  `<input class="mini-kg"   type="number" step="0.5" inputmode="decimal" placeholder="">`:''}
        ${fields.min? `<input class="mini-min"  type="number" min="0" inputmode="numeric" placeholder="">`:''}
        ${fields.sec? `<input class="mini-sec"  type="number" min="0" inputmode="numeric" placeholder="">`:''}
        <button class="iconbtn remove" title="Supprimer">−</button>
      `;
      row.querySelector('.iconbtn.remove').onclick = ()=> row.remove();
      container.appendChild(row);
    }

    document.getElementById('addRowSRK').onclick = ()=> addRow(rowsSRK,{sets:1,reps:1,kg:1});
    document.getElementById('addRowSR' ).onclick = ()=> addRow(rowsSR ,{sets:1,reps:1});
    document.getElementById('addRowR'  ).onclick = ()=> addRow(rowsR  ,{reps:1});
    document.getElementById('addRowT'  ).onclick = ()=> addRow(rowsT  ,{min:1,sec:1});
    document.getElementById('addRowW'  ).onclick = ()=> addRow(rowsW  ,{kg:1});

    function readRows(container){
      const arr = [];
      container.querySelectorAll('.mini-row').forEach(r=>{
        const get = sel => {
          const el = r.querySelector(sel);
          if(!el) return null;
          const v = el.value.trim();
          return v==='' ? null : Number(v);
        };
        arr.push({
          sets: get('.mini-sets'),
          reps: get('.mini-reps'),
          kg:   get('.mini-kg'),
          min:  get('.mini-min'),
          sec:  get('.mini-sec')
        });
      });
      // garde uniquement les lignes avec au moins une valeur
      return arr.filter(o=> Object.values(o).some(v=>v!==null));
    }

    // Résumés lisibles (sans libellés techniques)
    function trimKg(n){
      if(n==null || isNaN(n)) return '';
      return (Math.round(n*10)/10).toString().replace('.',',');
    }
    function lineSetsRepsKg(o){
      const s = o.sets ?? 0, r = o.reps ?? 0, kg = o.kg ?? null;
      if(s>0 && r>0 && kg!=null) return `${s}×${r} à ${trimKg(kg)} kg`;
      if(s>0 && r>0) return `${s}×${r}`;
      if(r>0 && kg!=null) return `${r} rép à ${trimKg(kg)} kg`;
      if(kg!=null) return `${trimKg(kg)} kg`;
      return null;
    }
    function lineSetsReps(o){
      const s = o.sets ?? 0, r = o.reps ?? 0;
      if(s>0 && r>0) return `${s}×${r}`;
      if(r>0) return `${r} rép`;
      return null;
    }
    function lineReps(o){
      const r = o.reps ?? 0;
      return r>0 ? `${r} rép` : null;
    }
    function lineTime(o){
      const m = o.min ?? 0, s = o.sec ?? 0;
      if(m>0 && s>0) return `${m} min ${s} s`;
      if(m>0) return `${m} min`;
      if(s>0) return `${s} s`;
      return null;
    }
    function lineWeight(o){
      return (o.kg!=null) ? `${trimKg(o.kg)} kg` : null;
    }

    function summarize(mode, rows){
      const map = {
        sets_reps_kg: lineSetsRepsKg,
        sets_reps:    lineSetsReps,
        reps:         lineReps,
        time:         lineTime,
        weight_only:  lineWeight
      };
      const fn = map[mode] || lineSetsRepsKg;
      return rows.map(fn).filter(Boolean);
    }

    // Ouvre/ferme la modale
    document.getElementById("fab").onclick = () => {
      fDate.value = formatDate(selectedDate);
      fName.value = '';
      fMode.value = 'sets_reps_kg';
      fNote.value = '';

      [rowsSRK,rowsSR,rowsR,rowsT,rowsW].forEach(c=>c.innerHTML='');
      addRow(rowsSRK,{sets:1,reps:1,kg:1});

      showModeBlock('sets_reps_kg');
      document.getElementById("msg").textContent = '';
      sheetBg.style.display = "flex";
    };
    document.getElementById("cancel").onclick = () => {
      sheetBg.style.display = "none";
      document.getElementById("msg").textContent = '';
    };
    sheetBg.addEventListener("click",(e)=>{
      if(e.target===sheetBg){
        sheetBg.style.display="none";
        document.getElementById("msg").textContent='';
      }
    });

    // Enregistrer
    document.getElementById("save").onclick = () => {
      const date = (fDate.value||'').trim();
      const name = (fName.value||'').trim();
      const mode = fMode.value;
      const note = (fNote.value||'').trim();

      if(!date || !name){
        document.getElementById("msg").textContent = "Nom et date requis.";
        return;
      }

      const rows = mode==='sets_reps_kg' ? readRows(rowsSRK)
                  : mode==='sets_reps'    ? readRows(rowsSR)
                  : mode==='reps'         ? readRows(rowsR)
                  : mode==='time'         ? readRows(rowsT)
                  :                         readRows(rowsW);

      if(rows.length===0){
        document.getElementById("msg").textContent = "Ajoute au moins une ligne.";
        return;
      }

      const lines = summarize(mode, rows); // <= ICI les lignes “5×4 à 130 kg”, “55 min 32 s”, “12 rép”, etc.

      const item = {
        id: String(Date.now()),
        date, name, mode, rows, note,
        lines
      };

      items.push(item);
      sheetBg.style.display = "none";
      renderList();
    };

    /***** NAV SEMAINE *****/
    document.getElementById("prev").onclick = () => {
      currentMonday.setDate(currentMonday.getDate()-7);
      renderWeek(); renderList();
    };
    document.getElementById("next").onclick = () => {
      currentMonday.setDate(currentMonday.getDate()+7);
      renderWeek(); renderList();
    };
    document.getElementById("today").onclick = () => {
      currentMonday = getMonday(new Date());
      selectedDate = new Date();
      renderWeek();
      fDate.value = formatDate(selectedDate);
      renderList();
    };

    /***** INIT *****/
    (function init(){
      renderWeek();
      fDate.value = formatDate(selectedDate);
      renderList();
    })();
  </script>
</body>
</html>
