<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Suivi — Semaine d’entraînement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --accent:#22c55e; --blue:#3b82f6; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px 16px 96px}

    /* Retour */
    .topbar{display:flex;align-items:center;margin-bottom:12px}
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--text);text-decoration:none;font-size:16px}
    .back svg{width:20px;height:20px;stroke:#fff}

    /* Header */
    .page-header h1{
      font-size:28px;font-weight:700;margin:0 0 4px;position:relative;padding-bottom:6px;text-align:left;
    }
    .page-header h1::after{
      content:"";position:absolute;left:0;bottom:0;width:72px;height:3px;background:var(--accent);border-radius:999px;
    }
    .page-header .subtitle{
      text-align:left;opacity:.85;font-size:16px;margin:0 0 16px;
    }

    /* Week bar */
    .weekbar{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0 14px}
    .navbtn{
      width:36px;height:36px;border-radius:50%;border:1px solid var(--line);
      background:var(--card);color:var(--text);display:grid;place-items:center;
      font-size:18px;cursor:pointer;transition:border-color .2s, transform .1s
    }
    .navbtn:hover{ border-color:var(--accent); transform:translateY(-1px) }
    .when{font-weight:600;font-size:15px;min-width:190px;text-align:center}

    /* Days pills */
    .days{display:flex;gap:8px;overflow-x:auto;padding:6px 0 10px;margin-bottom:12px;scroll-behavior:smooth}
    .daypill{
      flex:0 0 auto; min-width:72px; text-align:center; padding:10px 12px; border-radius:999px;
      border:1px solid var(--line); background:#0b1326; color:#fff; cursor:pointer; font-weight:500
    }
    .daypill small{display:block;opacity:.7}
    .daypill.active{background:var(--accent); color:#0b1326; border-color:var(--accent); font-weight:700}

    /* Liste */
    .list{display:grid;gap:12px}
    .empty{font-size:14px;color:var(--muted);opacity:.9;padding:8px}

    /* Event card */
    .ev{
      display:flex;gap:10px;align-items:stretch;background:var(--card);border:1px solid var(--line);
      border-radius:12px;padding:10px;position:relative;overflow:hidden
    }
    .ev .bar{width:6px;border-radius:8px;background:var(--accent);flex:0 0 6px}
    .ev .info{flex:1;min-width:0}
    .ev .title{font-weight:800;margin-bottom:4px;word-break:break-word}
    .ev .meta{font-size:13px;color:var(--muted)}
    .ev .del{position:absolute;top:6px;right:8px;border:none;background:transparent;color:#94a3b8;cursor:pointer;font-size:18px}
    .ev .del:hover{color:#fff}

    /* FAB */
    .fab{
      position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;
      display:grid;place-items:center;background:var(--accent);color:#0b1326;
      border:1px solid #1a2b1f;box-shadow:0 10px 30px rgba(0,0,0,.4);cursor:pointer;z-index:50;
      font-size:28px;font-weight:900
    }

    /* Bottom sheet */
    .sheet-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);
      display:none;align-items:flex-end;z-index:60
    }
    .sheet{
      width:100%;max-width:960px;margin:0 auto;background:var(--card);
      border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
      border-bottom:none;padding:12px 16px 16px;animation:slideup .18s ease-out;max-height:90vh;overflow:auto
    }
    @keyframes slideup{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}

    .row{display:flex;gap:8px;margin:8px 0;align-items:center}
    .row label{flex:0 0 110px;opacity:.9}
    .row input,.row select,.row textarea{
      flex:1;background:#0b1326;border:1px solid var(--line);border-radius:8px;color:#e5e7eb;padding:10px
    }
    .row textarea{min-height:70px;resize:vertical}

    .subtle{font-size:12px;color:var(--muted);margin-top:2px}

    /* Mini-grid (4 colonnes constantes : 3 champs + 1 bouton) */
    .mini-wrap{margin:8px 0 12px}
    .mini-header, .mini-row{
      display:grid; grid-template-columns:1fr 1fr 1fr 38px; gap:6px; align-items:center;
    }
    .mini-header{margin-bottom:4px}
    .mini-label{font-size:12px;color:#cbd5e1;opacity:.9}
    .mini-row input{
      width:100%;background:#0b1326;border:1px solid var(--line);border-radius:8px;color:#e5e7eb;
      padding:10px; text-align:center; font-variant-numeric:tabular-nums; -moz-appearance:textfield;
    }
    .mini-row input::-webkit-outer-spin-button, .mini-row input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }

    /* Icon buttons */
    .iconbtn{
      width:38px;height:38px;border-radius:10px;border:1px solid var(--line);background:#0b1326;color:#e5e7eb;
      display:grid;place-items:center;cursor:pointer;font-size:20px;line-height:1;
    }
    .iconbtn.add{background:var(--blue);border-color:#1e40af;color:#fff}
    .iconbtn.remove{background:#2a1212;border-color:#5c1e1e;color:var(--danger);font-weight:900}
    .mini-actions{display:flex;gap:8px;margin-top:6px}

    .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:8px}
    .btn{border:1px solid var(--line);border-radius:10px;background:#0b1326;color:#e5e7eb;padding:10px 14px;cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.primary{background:var(--accent);color:#0b1326;border-color:#1a2b1f;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a href="index.html" class="back">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Retour
      </a>
    </div>

    <header class="page-header">
      <h1>Suivi d’entraînement</h1>
      <div class="subtitle">Vue semaine • Ajoute les séances par jour</div>
    </header>

    <div class="weekbar">
      <button class="navbtn" id="prev">‹</button>
      <div class="when" id="when"></div>
      <button class="navbtn" id="today">⌂</button>
      <button class="navbtn" id="next">›</button>
    </div>

    <div class="days" id="days"></div>
    <div class="list" id="list"></div>

    <button class="fab" id="fab" title="Ajouter">＋</button>

    <!-- Bottom sheet -->
    <div class="sheet-backdrop" id="sheetBg">
      <div class="sheet">
        <h3 style="margin:4px 0 8px">Ajouter un exercice</h3>

        <div class="row">
          <label>Nom</label>
          <input id="fName" placeholder="" autocomplete="off">
        </div>

        <div class="row">
          <label>Mode</label>
          <select id="fMode">
            <option value="srk">Séries × Rép + Kg</option>
            <option value="sr">Séries × Rép</option>
            <option value="r">Répétitions</option>
            <option value="w">Kg seul</option>
            <option value="t">Temps (min/s)</option>
          </select>
        </div>

        <!-- SRK -->
        <div id="blkSRK" class="mini-wrap" data-block="srk">
          <div class="mini-header">
            <div class="mini-label">Séries</div>
            <div class="mini-label">Rép</div>
            <div class="mini-label">Kg</div>
            <div></div>
          </div>
          <div class="mini-rows"></div>
          <div class="mini-actions">
            <button class="iconbtn add" type="button" data-add="srk">＋</button>
          </div>
        </div>

        <!-- SR -->
        <div id="blkSR" class="mini-wrap" data-block="sr" style="display:none">
          <div class="mini-header">
            <div class="mini-label">Séries</div>
            <div class="mini-label">Rép</div>
            <div></div>
            <div></div>
          </div>
          <div class="mini-rows"></div>
          <div class="mini-actions">
            <button class="iconbtn add" type="button" data-add="sr">＋</button>
          </div>
        </div>

        <!-- R -->
        <div id="blkR" class="mini-wrap" data-block="r" style="display:none">
          <div class="mini-header">
            <div class="mini-label">Rép</div><div></div><div></div><div></div>
          </div>
          <div class="mini-rows"></div>
          <div class="mini-actions">
            <button class="iconbtn add" type="button" data-add="r">＋</button>
          </div>
        </div>

        <!-- W -->
        <div id="blkW" class="mini-wrap" data-block="w" style="display:none">
          <div class="mini-header">
            <div class="mini-label">Kg</div><div></div><div></div><div></div>
          </div>
          <div class="mini-rows"></div>
          <div class="mini-actions">
            <button class="iconbtn add" type="button" data-add="w">＋</button>
          </div>
        </div>

        <!-- T -->
        <div id="blkT" class="mini-wrap" data-block="t" style="display:none">
          <div class="mini-header">
            <div class="mini-label">Min</div>
            <div class="mini-label">Sec</div>
            <div></div>
            <div></div>
          </div>
          <div class="mini-rows"></div>
          <div class="mini-actions">
            <button class="iconbtn add" type="button" data-add="t">＋</button>
          </div>
        </div>

        <div class="row">
          <label>Commentaires</label>
          <textarea id="fCom" placeholder=""></textarea>
        </div>

        <div class="actions">
          <button class="btn ghost" id="cancel">Annuler</button>
          <button class="btn primary" id="save">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ====== Dates / Semaine ====== */
    const daysEl = document.getElementById("days");
    const listEl = document.getElementById("list");
    const whenEl = document.getElementById("when");
    let currentMonday = getMonday(new Date());
    let selectedDate = new Date();

    function getMonday(d){
      d = new Date(d);
      const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }
    function formatDate(d){
      const d2 = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      return d2.toISOString().split("T")[0];
    }
    function renderWeek(){
      daysEl.innerHTML = "";
      const pills=[];
      for(let i=0;i<7;i++){
        const day = new Date(currentMonday);
        day.setDate(day.getDate()+i);
        const pill = document.createElement("div");
        pill.className = "daypill";
        pill.dataset.date = formatDate(day);
        pill.innerHTML = `${day.toLocaleDateString("fr-FR",{weekday:"short"})}<small>${day.getDate()} ${day.toLocaleDateString("fr-FR",{month:"short"})}</small>`;
        pill.onclick=()=>{
          selectedDate=new Date(day);
          highlightSelected(formatDate(day));
          renderEntries();
          pill.scrollIntoView({ inline:"center", behavior:"smooth", block:"nearest" });
        };
        daysEl.appendChild(pill);
        pills.push(pill);
      }
      const end = new Date(currentMonday); end.setDate(end.getDate()+6);
      whenEl.textContent = `${currentMonday.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})} – ${end.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}`;
      highlightSelected(formatDate(selectedDate));
      const today = formatDate(new Date());
      const todayPill = pills.find(p=>p.dataset.date===today);
      if(todayPill) setTimeout(()=>todayPill.scrollIntoView({inline:"center",behavior:"smooth"}), 50);
    }
    function highlightSelected(dateStr){
      document.querySelectorAll(".daypill").forEach(p=>p.classList.remove("active"));
      const target=[...document.querySelectorAll(".daypill")].find(p=>p.dataset.date===dateStr);
      if(target) target.classList.add("active");
    }

    /* ====== Données (démo locale) ====== */
    let entries = []; // {id, date, name, mode, rows:[{...}], comment}

    /* ====== Rendu des entrées ====== */
    function renderEntries(){
      const dateStr = formatDate(selectedDate);
      const todays = entries.filter(e=>e.date===dateStr);
      listEl.innerHTML = "";
      if(todays.length===0){
        listEl.innerHTML = `<div class="empty">Aucune séance</div>`;
        return;
      }
      todays.forEach(e=>{
        const card = document.createElement("div");
        card.className = "ev";
        card.innerHTML = `
          <div class="bar"></div>
          <div class="info">
            <div class="title">${escapeHTML(e.name || '')}</div>
            <div class="meta">${escapeHTML(formatVolume(e))}${e.comment?` • ${escapeHTML(e.comment)}`:''}</div>
          </div>
          <button class="del" title="Supprimer">×</button>
        `;
        card.querySelector(".del").onclick = ()=>{
          if(!confirm("Supprimer cette entrée ?")) return;
          entries = entries.filter(x=>x.id!==e.id);
          renderEntries();
        };
        listEl.appendChild(card);
      });
    }

    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

    /* ====== Formatage du volume (affichage compact) ====== */
    function formatVolume(e){
      const parts = [];
      if(e.mode==='srk'){
        e.rows.forEach(r=>{
          const sets = num(r.sets), reps = num(r.reps), kg = numFloat(r.kg);
          if(sets||reps||kg!==null){
            const a = [];
            if(sets && reps) a.push(`${sets} x ${reps}`);
            else if(sets) a.push(`${sets} x`);
            else if(reps) a.push(`${reps}`);
            if(kg!==null) a.push(`à ${trimFloat(kg)} kg`);
            parts.push(a.join(' '));
          }
        });
      }else if(e.mode==='sr'){
        e.rows.forEach(r=>{
          const sets = num(r.sets), reps = num(r.reps);
          if(sets||reps) parts.push(`${sets||''}${sets&&reps?' x ':''}${reps||''}`.trim());
        });
      }else if(e.mode==='r'){
        e.rows.forEach(r=>{
          const reps = num(r.reps);
          if(reps) parts.push(`${reps} réps`);
        });
      }else if(e.mode==='w'){
        e.rows.forEach(r=>{
          const kg = numFloat(r.kg);
          if(kg!==null) parts.push(`${trimFloat(kg)} kg`);
        });
      }else if(e.mode==='t'){
        e.rows.forEach(r=>{
          const min = num(r.min), sec = num(r.sec);
          const t = [(min?`${min} min`:''),(sec?`${sec} s`:'')].filter(Boolean).join(' ');
          if(t) parts.push(t);
        });
      }
      return parts.join(' • ');
    }
    function num(v){ const n=parseInt(v,10); return Number.isFinite(n) ? n : 0; }
    function numFloat(v){ if(v===undefined||v===null||v==='') return null; const n=parseFloat(v); return Number.isFinite(n)?n:null; }
    function trimFloat(n){ return (Math.round(n*100)/100).toString().replace('.', ','); }

    /* ====== Bottom sheet + formulaire ====== */
    const sheetBg = document.getElementById("sheetBg");
    const fName = document.getElementById("fName");
    const fMode = document.getElementById("fMode");
    const fCom  = document.getElementById("fCom");

    const blkSRK = document.getElementById("blkSRK");
    const blkSR  = document.getElementById("blkSR");
    const blkR   = document.getElementById("blkR");
    const blkW   = document.getElementById("blkW");
    const blkT   = document.getElementById("blkT");

    document.getElementById("fab").onclick = openSheet;
    document.getElementById("cancel").onclick = closeSheet;
    sheetBg.addEventListener("click",(e)=>{ if(e.target===sheetBg) closeSheet(); });

    function openSheet(){
      fName.value = "";
      fCom.value  = "";
      fMode.value = "srk";
      switchMode();
      sheetBg.style.display = "flex";
    }
    function closeSheet(){ sheetBg.style.display = "none"; }

    fMode.addEventListener('change', switchMode);
    function switchMode(){
      // cacher tous
      [blkSRK, blkSR, blkR, blkW, blkT].forEach(b=>b.style.display='none');
      // montrer le bon
      const val = fMode.value;
      const map = { srk:blkSRK, sr:blkSR, r:blkR, w:blkW, t:blkT };
      const block = map[val];
      block.style.display = '';
      // reset lignes → conserver au moins 1 ligne vide
      ensureOneEmptyRow(block, val);
    }

    function rowsContainer(block){ return block.querySelector('.mini-rows'); }

    function ensureOneEmptyRow(block, mode){
      const cont = rowsContainer(block);
      cont.innerHTML = '';
      addRow(cont, fieldsFor(mode));
    }

    // Ajout d’une ligne selon les champs du mode
    function fieldsFor(mode){
      if(mode==='srk') return {sets:true, reps:true, kg:true};
      if(mode==='sr')  return {sets:true, reps:true};
      if(mode==='r')   return {reps:true};
      if(mode==='w')   return {kg:true};
      if(mode==='t')   return {min:true, sec:true};
      return {};
    }

    // === Fix d’alignement : 4 colonnes constantes, compléter par des vides ===
    function addRow(container, fields){
      const row = document.createElement('div');
      row.className = 'mini-row';

      const parts = [];
      if (fields.sets) parts.push('<input class="mini-sets" type="number" min="0" inputmode="numeric">');
      if (fields.reps) parts.push('<input class="mini-reps" type="number" min="0" inputmode="numeric">');
      if (fields.kg)   parts.push('<input class="mini-kg"   type="number" step="0.5" inputmode="decimal">');
      if (fields.min)  parts.push('<input class="mini-min"  type="number" min="0" inputmode="numeric">');
      if (fields.sec)  parts.push('<input class="mini-sec"  type="number" min="0" inputmode="numeric">');

      const emptyNeeded = Math.max(0, 3 - parts.length);
      for (let i=0;i<emptyNeeded;i++) parts.push('<div></div>');

      parts.push('<button class="iconbtn remove" type="button" title="Supprimer">−</button>');

      row.innerHTML = parts.join('');

      row.querySelector('.iconbtn.remove').onclick = ()=>{
        const count = container.querySelectorAll('.mini-row').length;
        if(count<=1){
          row.querySelectorAll('input').forEach(i=>i.value=''); // on garde 1 ligne vide
        }else{
          row.remove();
        }
      };
      container.appendChild(row);
    }

    // Boutons +
    document.querySelectorAll('[data-add]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const mode = btn.dataset.add;
        const block = document.querySelector(`.mini-wrap[data-block="${mode}"]`);
        addRow(rowsContainer(block), fieldsFor(mode));
      });
    });

    // Enregistrer
    document.getElementById("save").onclick = ()=>{
      const name = fName.value.trim();
      const mode = fMode.value;
      if(!name){ alert("Nom de l’exercice requis"); return; }

      const block = document.querySelector(`.mini-wrap[data-block="${mode}"]`);
      const cont  = rowsContainer(block);
      const rows = [...cont.querySelectorAll('.mini-row')].map(r=>{
        return {
          sets: getVal(r,'.mini-sets'),
          reps: getVal(r,'.mini-reps'),
          kg:   getVal(r,'.mini-kg'),
          min:  getVal(r,'.mini-min'),
          sec:  getVal(r,'.mini-sec'),
        };
      }).filter(row=>{
        // garder uniquement les lignes qui contiennent au moins une valeur
        return Object.values(row).some(v=>v!=='' && v!==null && v!==undefined);
      });

      const entry = {
        id: String(Date.now()),
        date: formatDate(selectedDate),
        name,
        mode,
        rows,
        comment: fCom.value.trim()
      };

      entries.push(entry);
      renderEntries();

      // Reset : garder au moins 1 ligne vide pour le bloc courant
      fName.value = '';
      fCom.value  = '';
      ensureOneEmptyRow(block, mode);
      closeSheet();
    };

    function getVal(root, sel){
      const el = root.querySelector(sel);
      return el ? el.value.trim() : '';
    }

    /* ====== Navigation semaine ====== */
    document.getElementById("prev").onclick = () => {
      currentMonday.setDate(currentMonday.getDate()-7);
      renderWeek(); renderEntries();
    };
    document.getElementById("next").onclick = () => {
      currentMonday.setDate(currentMonday.getDate()+7);
      renderWeek(); renderEntries();
    };
    document.getElementById("today").onclick = () => {
      currentMonday = getMonday(new Date());
      selectedDate = new Date();
      renderWeek(); renderEntries();
    };

    /* ====== Init ====== */
    (function init(){
      renderWeek();
      renderEntries();
    })();
  </script>
</body>
</html>
