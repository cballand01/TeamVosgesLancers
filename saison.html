<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Comp√©titions ‚Äî Groupe Athl√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--danger:#ef4444}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:24px 24px 96px}
    a.back{display:inline-flex;align-items:center;gap:6px;color:var(--text);text-decoration:none;margin-bottom:16px}
    h1{margin:0 0 8px}
    .subtitle{opacity:.85;margin-bottom:18px}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 16px}
    .tab{padding:8px 12px;border:1px solid #1f2937;border-radius:999px;background:#0b1326;color:var(--text);cursor:pointer}
    .tab.active{background:var(--accent);color:#0b1326;border-color:var(--accent)}

    .list{display:grid;gap:10px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:8px}
    .title{font-weight:700}
    .meta{font-size:13px;color:var(--muted)}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{font-size:12px;border:1px solid #334155;border-radius:999px;padding:3px 8px;color:#cbd5e1}

    .actions{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid #1f2937;border-radius:8px;background:#0b1326;color:var(--text);padding:6px 10px;cursor:pointer}
    .btn.danger{border-color:var(--danger);color:var(--danger)}

    .panel{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:12px;margin:16px 0}
    .row{display:flex;gap:8px;margin-bottom:10px;align-items:center}
    .row label{flex:0 0 120px;opacity:.9}
    .row input,.row select,.row textarea{flex:1;background:#0b1326;border:1px solid #1f2937;border-radius:8px;color:var(--text);padding:8px}
    .checks{display:flex;gap:10px;flex-wrap:wrap}
    .checks label{display:inline-flex;gap:6px;align-items:center}
    .help{font-size:12px;color:var(--muted)}

    @media (max-width:640px){
      .card{grid-template-columns:1fr}
      .actions{justify-content:flex-end}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="index.html" class="back">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Retour
    </a>
    <h1>Comp√©titions</h1>
    <div class="subtitle">Liste des comp√©titions √† venir / pass√©es </div>

    <!-- Onglets -->
    <div class="tabs">
      <button class="tab active" data-view="upcoming">√Ä venir</button>
      <button class="tab" data-view="past">Pass√©es</button>
      <button class="tab" data-view="new">Ajouter comp√©tition</button>
    </div>

    <!-- Liste -->
    <div id="lists">
      <div id="list-upcoming" class="list"></div>
      <div id="list-past" class="list" style="display:none"></div>

      <!-- Formulaire d'ajout -->
      <div id="panel-new" class="panel" style="display:none">
        <div class="row">
          <label>Date</label>
          <input id="fDate" type="date">
        </div>
        <div class="row">
          <label>Lieu</label>
          <input id="fLieu" placeholder="Ville / stade">
        </div>
        <div class="row">
          <label>Type</label>
          <select id="fType">
            <option value="Meeting">Meeting</option>
            <option value="Championnats">Championnats</option>
            <option value="Interclubs">Interclubs</option>
            <option value="Stage">Stage</option>
            <option value="Test">Test</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        <div class="row">
          <label>√âpreuves</label>
          <div class="checks">
            <label><input type="checkbox" value="Disque" class="fEp"> Disque</label>
            <label><input type="checkbox" value="Poids" class="fEp"> Poids</label>
            <label><input type="checkbox" value="Javelot" class="fEp"> Javelot</label>
            <label><input type="checkbox" value="Marteau" class="fEp"> Marteau</label>
          </div>
        </div>
        <div class="row">
          <label>Infos</label>
          <textarea id="fInfos" rows="3" placeholder="D√©tails, lien‚Ä¶"></textarea>
        </div>
        <div class="row">
          <span class="help">Tout le monde peut ajouter/supprimer. Merci d‚Äô√©viter les doublons üôè</span>
          <span style="flex:1"></span>
          <button id="btnAdd" class="btn">Ajouter</button>
        </div>
        <div id="msg" class="help"></div>
      </div>
    </div>
  </div>

  <script>
    const API = 'YOUR_APPS_SCRIPT_URL_HERE'; // <= colle l‚ÄôURL /exec

    // State
    let ITEMS = [];

    // Helpers
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

    function isoToDate(s){ const p=s.split('-'); return new Date(+p[0], p[1]-1, +p[2]); }
    function fmtDateFR(s){
      const d = isoToDate(s);
      return d.toLocaleDateString('fr-FR', { year:'numeric', month:'long', day:'numeric' });
    }
    function todayISO(){
      const d=new Date();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${m}-${day}`;
    }

    async function fetchAll(){
      const r = await fetch(API);
      const j = await r.json();
      ITEMS = (j.items||[]).filter(x=>x.date); // s√©curit√©
      render();
    }

    async function createItem(payload){
      const r = await fetch(API, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'create', item:payload})
      });
      return r.json();
    }

    async function deleteItem(id){
      const r = await fetch(API, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'delete', id})
      });
      return r.json();
    }

    function render(){
      const today = todayISO();
      const upcoming = ITEMS
        .filter(x => x.date >= today)
        .sort((a,b)=> a.date.localeCompare(b.date));
      const past = ITEMS
        .filter(x => x.date < today)
        .sort((a,b)=> b.date.localeCompare(a.date));

      renderList($('#list-upcoming'), upcoming, false);
      renderList($('#list-past'), past, true);
    }

    function renderList(root, arr, isPast){
      root.innerHTML = '';
      if (arr.length === 0) {
        root.innerHTML = `<div class="help">${isPast ? 'Aucune comp√©tition pass√©e.' : 'Aucune comp√©tition √† venir.'}</div>`;
        return;
      }
      for (const it of arr){
        const card = document.createElement('div');
        card.className = 'card';

        const left = document.createElement('div');
        left.innerHTML = `
          <div class="title">${fmtDateFR(it.date)} ‚Äî ${it.lieu || ''}</div>
          <div class="meta">${it.type || 'Comp√©tition'}</div>
          ${it.epreuves ? `<div class="chips">${it.epreuves.split(',').map(s=>s.trim()).filter(Boolean).map(s=>`<span class="chip">${s}</span>`).join('')}</div>` : ''}
          ${it.infos ? `<div class="meta" style="margin-top:6px">${it.infos}</div>` : ''}
        `;

        const right = document.createElement('div');
        right.className = 'actions';
        const del = document.createElement('button');
        del.className = 'btn danger';
        del.textContent = 'Supprimer';
        del.onclick = async ()=>{
          if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette comp√©tition ?')) return;
          const res = await deleteItem(it.id);
          if (res && res.ok){
            ITEMS = ITEMS.filter(x=>x.id !== it.id);
            render();
          } else {
            alert('Suppression impossible.');
          }
        };
        right.appendChild(del);

        card.appendChild(left);
        card.appendChild(right);
        root.appendChild(card);
      }
    }

    // Onglets
    $$('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        $$('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const v = t.dataset.view;
        $('#list-upcoming').style.display = (v==='upcoming') ? '' : 'none';
        $('#list-past').style.display     = (v==='past') ? '' : 'none';
        $('#panel-new').style.display     = (v==='new') ? '' : 'none';
      });
    });

    // Ajout
    $('#btnAdd').addEventListener('click', async ()=>{
      const date = $('#fDate').value;
      const lieu = $('#fLieu').value.trim();
      const type = $('#fType').value;
      const epreuves = $$('.fEp:checked').map(x=>x.value).join(', ');
      const infos = $('#fInfos').value.trim();

      if (!date) { alert('La date est obligatoire'); return; }
      const payload = { date, lieu, type, epreuves, infos };
      $('#msg').textContent = 'Envoi‚Ä¶';
      const res = await createItem(payload);
      if (res && res.ok && res.item){
        ITEMS.push(res.item);
        // reset
        $('#fDate').value = '';
        $('#fLieu').value = '';
        $('#fType').value = 'Meeting';
        $$('.fEp').forEach(x=>x.checked=false);
        $('#fInfos').value = '';
        $('#msg').textContent = '‚úÖ Ajout√© !';
        render();
        // retour √† l‚Äôonglet "√Ä venir" si la date >= aujourd‚Äôhui
        $$('.tab').forEach(x=>x.classList.remove('active'));
        const tab = (payload.date >= todayISO()) ? $('[data-view="upcoming"]') : $('[data-view="past"]');
        tab.classList.add('active');
        $('#list-upcoming').style.display = (payload.date >= todayISO()) ? '' : 'none';
        $('#list-past').style.display     = (payload.date <  todayISO()) ? '' : 'none';
        $('#panel-new').style.display     = 'none';
      } else {
        $('#msg').textContent = '‚ùå Erreur lors de l‚Äôajout';
      }
    });

    // Init
    (function init(){
      $('#fDate').value = todayISO();
      fetchAll();
    })();
  </script>
</body>
</html>
