<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Saison — Groupe Athlé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --accent:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px 16px 96px}

    /* Retour + titre */
    .topbar{display:flex;align-items:center;margin-bottom:8px}
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--text);text-decoration:none;font-size:16px}
    .back svg{width:20px;height:20px;stroke:#fff}
    h1{margin:8px 0 4px;font-size:28px;font-weight:700;text-align:left}
    .subtitle{text-align:left;opacity:.7;font-size:16px;margin-bottom:16px}

    /* Loader */
    .loading{display:none;align-items:center;gap:8px;margin:8px 0 14px}
    .spinner{
      width:16px;height:16px;border-radius:50%;
      border:2px solid rgba(34,197,94,.25);
      border-top-color:var(--accent);
      animation:spin .7s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-size:14px;color:var(--muted)}

    /* Sous-titres de section */
    .section-title{
      font-size:18px;
      font-weight:600;
      margin:12px 0 8px;
      color:var(--text);
    }

    /* Liste */
    .list{display:grid;gap:10px;margin-bottom:18px}
    .separator{border-top:1px solid #334155;margin:18px 0;opacity:.5}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:8px}
    .title{font-weight:700}
    .meta{font-size:13px;color:var(--muted)}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{font-size:12px;border:1px solid #334155;border-radius:999px;padding:3px 8px;color:#cbd5e1}
    .actions{display:flex;align-items:center}
    .btn.danger{border:1px solid var(--danger);border-radius:8px;background:#0b1326;color:var(--danger);padding:4px 8px;cursor:pointer}

    /* FAB */
    .fab{
      position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:var(--accent);color:#0b1326;
      border:1px solid #1a2b1f;box-shadow:0 10px 30px rgba(0,0,0,.4);cursor:pointer;z-index:50;
      font-size:28px;font-weight:900;
    }

    /* Bottom sheet */
    .sheet-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);
      display:none;align-items:flex-end;z-index:60
    }
    .sheet{
      width:100%;max-width:960px;margin:0 auto;background:var(--card);
      border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
      border-bottom:none;padding:12px 16px 16px;animation:slideup .18s ease-out;max-height:85vh;overflow:auto
    }
    @keyframes slideup{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}

    .row{display:flex;gap:8px;margin:8px 0;align-items:center}
    .row label{flex:0 0 110px;opacity:.9}
    .row input,.row select,.row textarea{flex:1;background:#0b1326;border:1px solid var(--line);border-radius:8px;color:var(--text);padding:8px}

    /* Grid pour épreuves (2 colonnes compactes) */
    .checks{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .checks label{display:flex;align-items:center;gap:4px;font-size:14px;line-height:1.2}
    .checks input{margin:0;transform:scale(0.9)}

    .sheet .actions{display:flex;gap:8px;margin-top:8px}
    .btn{border:1px solid var(--line);border-radius:10px;background:#0b1326;color:var(--text);padding:8px 12px;cursor:pointer}
    .btn.ghost{background:transparent}
    .subtitle.small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Retour -->
    <div class="topbar">
      <a href="index.html" class="back">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Retour
      </a>
    </div>

    <!-- TITRES -->
    <h1>Calendrier</h1>
    <div class="subtitle">Toutes les compétitions de la saison</div>

    <!-- LOADER -->
    <div id="loading" class="loading">
      <div class="spinner" aria-hidden="true"></div>
    </div>

    <!-- LISTES -->
    <div class="section-title">À venir</div>
    <div class="list" id="list-upcoming"></div>

    <div class="separator"></div>

    <div class="section-title">Passées</div>
    <div class="list" id="list-past"></div>

    <!-- FAB -->
    <button class="fab" id="fab" title="Ajouter">＋</button>

    <!-- Bottom sheet -->
    <div class="sheet-backdrop" id="sheetBg">
      <div class="sheet">
        <h3 style="margin:4px 0 8px">Ajouter une compétition</h3>
        <div class="row"><label>Date</label><input id="fDate" type="date"></div>
        <div class="row"><label>Lieu</label><input id="fLieu" placeholder="Ville / stade"></div>
        <div class="row"><label>Type</label>
          <select id="fType">
            <option value="Meeting">Meeting</option>
            <option value="Championnats">Championnats</option>
            <option value="Interclubs">Interclubs</option>
            <option value="Stage">Stage</option>
            <option value="Test">Test</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        <div class="row"><label>Épreuves</label>
          <div class="checks">
            <label><input type="checkbox" value="Disque" class="fEp"> Disque</label>
            <label><input type="checkbox" value="Poids" class="fEp"> Poids</label>
            <label><input type="checkbox" value="Javelot" class="fEp"> Javelot</label>
            <label><input type="checkbox" value="Marteau" class="fEp"> Marteau</label>
          </div>
        </div>
        <div class="row"><label>Infos</label><textarea id="fInfos" rows="3" placeholder="Détails, lien…"></textarea></div>
        <div class="actions">
          <button class="btn ghost" id="cancel">Annuler</button>
          <button class="btn" id="save">Ajouter</button>
        </div>
        <div id="msg" class="subtitle small" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbzmiwr_iNJpEiF2XY-jn8RkzPg_OrWNV5QSaEO5bL2k3B7KVAdERutAGGjUfIpIIwxT/exec';

    let ITEMS = [];
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

    function isoToDate(s){const p=s.split('-');return new Date(+p[0],p[1]-1,+p[2]);}
    function fmtDateFR(s){const d=isoToDate(s);return d.toLocaleDateString('fr-FR',{year:'numeric',month:'long',day:'numeric'});}
    function todayISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}

    async function fetchAll(){
      const loader = $('#loading');
      try{
        loader.style.display = 'flex';                 // ⬅️ affiche le spinner
        const r = await fetch(API + '?resource=competitions');
        const j = await r.json();
        ITEMS = (j.items||[]).filter(x=>x.date);
        render();
      }catch(e){
        console.error(e);
      }finally{
        loader.style.display = 'none';                 // ⬅️ cache le spinner
      }
    }

    async function createItem(payload){
      const form = new URLSearchParams();
      form.append('resource','competitions');
      form.append('action','create');
      form.append('item', JSON.stringify(payload));
      const r = await fetch(API, { method:'POST', body: form });
      return r.json();
    }

    async function deleteItem(id){
      const form = new URLSearchParams();
      form.append('resource','competitions');
      form.append('action','delete');
      form.append('id', id);
      const r = await fetch(API, { method:'POST', body: form });
      return r.json();
    }

    function render(){
      const today=todayISO();
      const upcoming=ITEMS.filter(x=>x.date>=today).sort((a,b)=>a.date.localeCompare(b.date));
      const past=ITEMS.filter(x=>x.date<today).sort((a,b)=>b.date.localeCompare(a.date));
      renderList($('#list-upcoming'),upcoming);
      renderList($('#list-past'),past);
    }

    function renderList(root,arr){
      root.innerHTML='';
      if(arr.length===0){root.innerHTML='<div class="meta">Aucune compétition.</div>';return;}
      arr.forEach(it=>{
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=`
          <div>
            <div class="title">${fmtDateFR(it.date)} — ${it.lieu||''}</div>
            <div class="meta">${it.type||'Compétition'}</div>
            ${it.epreuves?`<div class="chips">${it.epreuves.split(',').map(s=>`<span class="chip">${s.trim()}</span>`).join('')}</div>`:''}
            ${it.infos?`<div class="meta" style="margin-top:6px">${it.infos}</div>`:''}
          </div>
          <div class="actions"><button class="btn danger" onclick="onDelete('${it.id}')">Supprimer</button></div>`;
        root.appendChild(card);
      });
    }

    async function onDelete(id){
      if(!confirm("Êtes-vous sûr ?"))return;
      const res=await deleteItem(id);
      if(res&&res.ok){ITEMS=ITEMS.filter(x=>x.id!==id);render();}
      else alert('Suppression impossible.');
    }

    // FAB & bottom sheet
    const sheetBg=$('#sheetBg');
    $('#fab').onclick=()=>{ $('#msg').textContent=''; sheetBg.style.display='flex'; };
    $('#cancel').onclick=()=>{ sheetBg.style.display='none'; $('#msg').textContent=''; };
    sheetBg.addEventListener('click',e=>{ if(e.target===sheetBg){ sheetBg.style.display='none'; $('#msg').textContent=''; } });

    // Sauvegarde
    $('#save').onclick=async()=>{
      const date=$('#fDate').value, lieu=$('#fLieu').value.trim(), type=$('#fType').value;
      const epreuves=$$('.fEp:checked').map(x=>x.value).join(', '), infos=$('#fInfos').value.trim();
      if(!date){alert('La date est obligatoire');return;}
      const payload={date,lieu,type,epreuves,infos};
      $('#msg').textContent='Envoi...';
      const res=await createItem(payload);
      if(res&&res.ok&&res.item){
        ITEMS.push(res.item);
        render();
        // reset + nettoyage du message + date du jour
        $('#msg').textContent='';
        $('#fDate').value=todayISO();
        $('#fLieu').value='';
        $('#fType').value='Meeting';
        $$('.fEp').forEach(x=>x.checked=false);
        $('#fInfos').value='';
        sheetBg.style.display='none';
      } else {
        $('#msg').textContent='Erreur.';
      }
    };

    (function init(){
      $('#fDate').value=todayISO();
      fetchAll();
    })();
  </script>
</body>
</html>
