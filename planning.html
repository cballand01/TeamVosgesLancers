<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Planning — Groupe Athlé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --accent:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px 16px 96px}

    /* Retour */
    .topbar{display:flex;align-items:center;margin-bottom:12px}
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--text);text-decoration:none;font-size:16px}
    .back svg{width:20px;height:20px;stroke:#fff}

    /* ===== Header commun (même DA que Records) ===== */
    .page-header h1{
      font-size:28px; font-weight:700; margin:0 0 4px; position:relative; padding-bottom:6px; text-align:left;
    }
    .page-header h1::after{
      content:""; position:absolute; left:0; bottom:0; width:72px; height:3px; background:var(--accent); border-radius:999px;
    }
    .page-header .subtitle{
      text-align:left; opacity:.8; font-size:16px; margin:0 0 24px;
    }

    /* Spinner compact */
    .loading{display:none;align-items:center;gap:8px;margin:12px 0 16px}
    .loading .dot{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(34,197,94,.25);
      border-top-color:var(--accent);
      animation:spin .7s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading .txt{font-size:13px;color:var(--muted)}

    /* Week bar */
    .weekbar{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:16px}
    .navbtn{
      width:36px;height:36px;border-radius:50%;border:1px solid var(--line);
      background:var(--card);color:var(--text);display:grid;place-items:center;
      font-size:18px;cursor:pointer;transition:border-color .2s, transform .1s
    }
    .navbtn:hover{ border-color:var(--accent); transform:translateY(-1px) }
    .when{font-weight:600;font-size:15px;min-width:190px;text-align:center}

    /* Days pills */
    .days{display:flex;gap:8px;overflow-x:auto;padding:6px 0 10px;margin-bottom:16px;scroll-behavior:smooth}
    .daypill{
      flex:0 0 auto; min-width:72px; text-align:center; padding:10px 12px; border-radius:999px;
      border:1px solid var(--line); background:#0b1326; color:#fff; cursor:pointer; font-weight:500
    }
    .daypill small{display:block;opacity:.7}
    .daypill.active{background:var(--accent); color:#0b1326; border-color:var(--accent); font-weight:700}

    /* List & events */
    .list{display:grid;gap:12px}
    .empty{font-size:14px;color:var(--muted);opacity:.9;padding:8px}

    .ev{
      display:flex;gap:10px;align-items:stretch;background:var(--card);border:1px solid var(--line);
      border-radius:12px;padding:10px;position:relative;overflow:hidden
    }
    .ev .bar{width:6px;border-radius:8px;background:var(--accent);flex:0 0 6px}
    .ev .info{flex:1;min-width:0}
    .ev .title{font-weight:800;margin-bottom:2px}
    .ev .meta{font-size:13px;color:var(--muted)}
    .ev .meta strong{color:#e5e7eb}
    .ev .del{position:absolute;top:6px;right:8px;border:none;background:transparent;color:#94a3b8;cursor:pointer;font-size:18px}
    .ev .del:hover{color:#fff}

    /* FAB */
    .fab{
      position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;
      display:grid;place-items:center;background:var(--accent);color:#0b1326;
      border:1px solid #1a2b1f;box-shadow:0 10px 30px rgba(0,0,0,.4);cursor:pointer;z-index:50;
      font-size:28px;font-weight:900
    }

    /* Bottom sheet */
    .sheet-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);
      display:none;align-items:flex-end;z-index:60
    }
    .sheet{
      width:100%;max-width:960px;margin:0 auto;background:var(--card);
      border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
      border-bottom:none;padding:12px 16px 16px;animation:slideup .18s ease-out;max-height:85vh;overflow:auto
    }
    @keyframes slideup{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}

    .row{display:flex;gap:8px;margin:8px 0;align-items:center}
    .row label{flex:0 0 110px;opacity:.9}
    .row input{flex:1;background:#0b1326;border:1px solid var(--line);border-radius:8px;color:#e5e7eb;padding:10px}

    .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:8px}
    .btn{border:1px solid var(--line);border-radius:10px;background:#0b1326;color:#e5e7eb;padding:8px 12px;cursor:pointer}
    .btn.ghost{background:transparent}
    .subtitle.small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a href="index.html" class="back">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Retour
      </a>
    </div>

    <!-- ===== Header commun ===== -->
    <header class="page-header">
      <h1>Planning</h1>
      <div class="subtitle">Vue de la semaine — Créneaux d’entraînement</div>
    </header>

    <!-- Spinner compact -->
    <div id="loading" class="loading">
      <div class="dot" aria-hidden="true"></div>
      <div class="txt">Chargement…</div>
    </div>

    <!-- Semaine -->
    <div class="weekbar">
      <button class="navbtn" id="prev">‹</button>
      <div class="when" id="when"></div>
      <button class="navbtn" id="today">⌂</button>
      <button class="navbtn" id="next">›</button>
    </div>

    <div class="days" id="days"></div>
    <div class="list" id="list"></div>

    <button class="fab" id="fab" title="Ajouter">＋</button>

    <!-- Bottom sheet -->
    <div class="sheet-backdrop" id="sheetBg">
      <div class="sheet">
        <h3 style="margin:4px 0 8px">Ajouter un créneau</h3>
        <div class="row"><label>Date</label><input id="fDate" type="date"></div>
        <!-- ⬇️ time pickers + step à la minute -->
        <div class="row"><label>Début</label><input id="fStart" type="time" step="60" value="18:00" inputmode="numeric"></div>
        <div class="row"><label>Fin</label><input id="fEnd" type="time" step="60" value="19:00" inputmode="numeric"></div>
        <div class="row"><label>Lieu</label><input id="fLieu" placeholder="Ville / Stade"></div>
        <div class="actions">
          <button class="btn ghost" id="cancel">Annuler</button>
          <button class="btn" id="save">Ajouter</button>
        </div>
        <div id="msg" class="subtitle small" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbx-gKwaUkf6Ewo17HMYPadDaRpGlYNbXrok5Ng42zL7mrNuUldoVCYRw3sjDx7V8GZG/exec';

    const daysEl = document.getElementById("days");
    const listEl = document.getElementById("list");
    const whenEl = document.getElementById("when");
    const loadingEl = document.getElementById("loading");
    const sheetBg = document.getElementById("sheetBg");
    const fDate = document.getElementById("fDate");
    const fStart = document.getElementById("fStart");
    const fEnd = document.getElementById("fEnd");
    const fLieu = document.getElementById("fLieu");

    let currentMonday = getMonday(new Date());
    let selectedDate = new Date();
    let events = [];
    let endTouched = false; // ← si l’utilisateur a modifié l’heure de fin à la main

    /* ==== Helpers time ==== */
    function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }
    function parseTimeToMinutes(str){
      if(!str) return null;
      let s = String(str).trim().toLowerCase().replace(/[h]/,' : ');
      // cas simples: "18", "9", "1830", "18 30"
      if(/^\d{1,2}$/.test(s)) return clamp(parseInt(s,10),0,23)*60;
      if(/^\d{3,4}$/.test(s)){ // 930 ou 0930 ou 1830
        const pad = s.padStart(4,'0'); const hh = +pad.slice(0,2), mm = +pad.slice(2);
        return clamp(hh,0,23)*60 + clamp(mm,0,59);
      }
      const m = s.match(/(\d{1,2})\D+(\d{1,2})/);
      if(m){ const hh = clamp(parseInt(m[1],10),0,23); const mm = clamp(parseInt(m[2],10),0,59); return hh*60+mm; }
      const m2 = s.match(/(\d{1,2})/);
      if(m2){ return clamp(parseInt(m2[1],10),0,23)*60; }
      return null;
    }
    function minutesToHHMM(min){
      const h = Math.floor(min/60), m = min%60;
      return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
    }
    function normalizeTimeInput(input){
      const mins = parseTimeToMinutes(input.value);
      if(mins===null) return; // on ne touche pas si vide/invalide
      input.value = minutesToHHMM(mins);
    }
    function addMinutesHHMM(hhmm, delta){
      const mins = parseTimeToMinutes(hhmm);
      if(mins===null) return hhmm;
      const newM = (mins + delta + 24*60) % (24*60);
      return minutesToHHMM(newM);
    }

    /* ==== Semaine ==== */
    function getMonday(d){
      d = new Date(d);
      const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }
    function formatDate(d){
      const d2 = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      return d2.toISOString().split("T")[0];
    }

    function renderWeek(){
      daysEl.innerHTML = "";
      const pills = [];
      for(let i=0;i<7;i++){
        const day = new Date(currentMonday);
        day.setDate(day.getDate()+i);
        const pill = document.createElement("div");
        pill.className = "daypill";
        pill.dataset.date = formatDate(day);
        pill.innerHTML = `${day.toLocaleDateString("fr-FR",{weekday:"short"})}<small>${day.getDate()} ${day.toLocaleDateString("fr-FR",{month:"short"})}</small>`;
        pill.onclick = () => {
          selectedDate = new Date(day);
          fDate.value = formatDate(selectedDate);
          highlightSelected(pill.dataset.date);
          renderEvents();
          pill.scrollIntoView({ inline:"center", behavior:"smooth", block:"nearest" });
        };
        daysEl.appendChild(pill);
        pills.push(pill);
      }
      const end = new Date(currentMonday);
      end.setDate(end.getDate()+6);
      whenEl.textContent = `${currentMonday.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})} – ${end.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}`;

      highlightSelected(formatDate(selectedDate));
      const today = formatDate(new Date());
      const todayPill = pills.find(p=>p.dataset.date===today);
      if(todayPill) setTimeout(()=>todayPill.scrollIntoView({inline:"center",behavior:"smooth"}), 50);
    }

    function highlightSelected(dateStr){
      document.querySelectorAll(".daypill").forEach(p=>p.classList.remove("active"));
      const target = Array.from(document.querySelectorAll(".daypill")).find(p=>p.dataset.date===dateStr);
      if(target) target.classList.add("active");
    }

    function renderEvents(){
      const dateStr = formatDate(selectedDate);
      const todays = events
        .filter(e=>e.date===dateStr)
        .sort((a,b)=>a.start.localeCompare(b.start));
      listEl.innerHTML = "";
      if(todays.length===0){
        listEl.innerHTML = `<div class="empty">Aucun entraînement</div>`;
        return;
      }
      todays.forEach(e=>{
        const card = document.createElement("div");
        card.className = "ev";
        card.innerHTML = `
          <div class="bar"></div>
          <div class="info">
            <div class="title">${e.lieu || ''}</div>
            <div class="meta"><strong>${e.start}</strong> – ${e.end}</div>
          </div>
          <button class="del" title="Supprimer">×</button>
        `;
        card.querySelector(".del").onclick = async () => {
          if(!confirm("Supprimer ce créneau ?")) return;
          const ok = await apiDelete(e.id);
          if(ok){
            events = events.filter(x=>x.id!==e.id);
            renderEvents();
          }else{
            alert("Suppression impossible.");
          }
        };
        listEl.appendChild(card);
      });
    }

    async function apiFetchAll(){
      loadingEl.style.display='flex';
      try{
        const r = await fetch(API+'?resource=planning', { method: 'GET' });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Erreur API');
        events = (j.items || []).map(x => ({
          id: x.id,
          date: x.date,
          start: x.start,
          end: x.end,
          lieu: x.lieu || ''
        }));
        renderEvents();
      }catch(err){
        console.error(err);
        listEl.innerHTML = `<div class="empty">Erreur de chargement : ${String(err.message || err)}</div>`;
      }finally{
        loadingEl.style.display='none';
      }
    }

    async function apiCreate(item){
      const form = new URLSearchParams();
      form.append('resource','planning');
      form.append('action','create');
      form.append('item', JSON.stringify(item));
      const r = await fetch(API, { method:'POST', body: form });
      return r.json();
    }

    async function apiDelete(id){
      const form = new URLSearchParams();
      form.append('resource','planning');
      form.append('action','delete');
      form.append('id', id);
      const r = await fetch(API, { method:'POST', body: form });
      const j = await r.json();
      return !!(j && j.ok);
    }

    // Navigation semaine
    document.getElementById("prev").onclick = () => { currentMonday.setDate(currentMonday.getDate()-7); renderWeek(); renderEvents(); };
    document.getElementById("next").onclick = () => { currentMonday.setDate(currentMonday.getDate()+7); renderWeek(); renderEvents(); };
    document.getElementById("today").onclick = () => {
      currentMonday = getMonday(new Date());
      selectedDate = new Date();
      renderWeek();
      fDate.value = formatDate(selectedDate);
      renderEvents();
    };

    // Bottom sheet (ajout)
    document.getElementById("fab").onclick = () => {
      fDate.value = formatDate(selectedDate);
      document.getElementById("msg").textContent = '';
      endTouched = false; // reset
      sheetBg.style.display = "flex";
    };
    document.getElementById("cancel").onclick = () => {
      sheetBg.style.display = "none";
      document.getElementById("msg").textContent = '';
    };
    sheetBg.addEventListener("click",(e)=>{
      if(e.target===sheetBg){
        sheetBg.style.display="none";
        document.getElementById("msg").textContent='';
      }
    });

    // ===== Auto-format & fin +1h =====
    // Normalise HH:mm si l’utilisateur tape "18", "1830", "18h", etc.
    fStart.addEventListener('blur', ()=> {
      normalizeTimeInput(fStart);
      if(!endTouched){ // ne pas écraser si l’utilisateur a touché la fin
        fEnd.value = addMinutesHHMM(fStart.value||'00:00', 60);
      }
    });
    fEnd.addEventListener('blur', ()=> normalizeTimeInput(fEnd));
    fEnd.addEventListener('input', ()=> { endTouched = true; });
    fEnd.addEventListener('focus', ()=> { endTouched = true; });

    // Si on change l’heure de début via le picker "time"
    fStart.addEventListener('input', ()=> {
      // La valeur input d’un type="time" est déjà HH:mm, mais on sécurise.
      normalizeTimeInput(fStart);
      if(!endTouched){
        fEnd.value = addMinutesHHMM(fStart.value||'00:00', 60);
      }
    });

    document.getElementById("save").onclick = async () => {
      // normalise une dernière fois
      normalizeTimeInput(fStart);
      normalizeTimeInput(fEnd);

      const date = fDate.value.trim(),
            start = fStart.value.trim(),
            end   = fEnd.value.trim(),
            lieu  = fLieu.value.trim();
      if(!date || !start || !end || !lieu){
        document.getElementById("msg").textContent = "Merci de remplir tous les champs.";
        return;
      }
      const item = { id:String(Date.now()), date, start, end, lieu };
      document.getElementById("msg").textContent = "Envoi…";
      try{
        const res = await apiCreate(item);
        if(res && res.ok){
          events.push(res.item || item);
          document.getElementById("msg").textContent = "";
          sheetBg.style.display = "none";
          // reset
          fStart.value = "18:00";
          fEnd.value   = "19:00";
          fLieu.value  = "";
          endTouched = false;
          if(formatDate(selectedDate) === date) renderEvents();
        }else{
          document.getElementById("msg").textContent = "Erreur: " + (res && res.error ? res.error : 'API');
        }
      }catch(err){
        document.getElementById("msg").textContent = "Erreur: " + String(err.message || err);
      }
    };

    // Init
    (function init(){
      renderWeek();
      fDate.value = formatDate(selectedDate);
      // valeurs par défaut cohérentes
      fStart.value = fStart.value || "18:00";
      fEnd.value   = fEnd.value   || "19:00";
      apiFetchAll();
    })();
  </script>
</body>
</html>
