<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Planning — Groupe Athlé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --accent:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px 16px 96px}

    /* Retour + titre centré */
    .topbar{display:flex;align-items:center;margin-bottom:8px}
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--text);text-decoration:none;font-size:16px}
    .back svg{width:20px;height:20px;stroke:#fff}
    h1{margin:4px 0 0;text-align:center;font-size:26px}
    .subtitle{text-align:center;opacity:.7;font-size:14px;margin-bottom:16px}

    /* Barre semaine : icônes rondes */
    .weekbar{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
    .navbtn{
      width:36px;height:36px;border-radius:50%;border:1px solid var(--line);
      background:var(--card);color:var(--text);display:grid;place-items:center;
      font-size:18px;cursor:pointer
    }
    .navbtn:active{transform:scale(0.98)}
    .when{font-weight:600;font-size:15px;min-width:190px;text-align:center}

    /* Day pills (scrollable) */
    .days{display:flex;gap:8px;overflow-x:auto;padding:6px 0 10px;margin-bottom:8px;scroll-behavior:smooth}
    .daypill{
      flex:0 0 auto; min-width:72px; text-align:center; padding:10px 12px; border-radius:999px;
      border:1px solid var(--line); background:#0b1326; color:var(--text); cursor:pointer;
      font-weight:500
    }
    .daypill small{display:block;opacity:.7}
    .daypill.active{background:var(--accent); color:#0b1326; border-color:var(--accent); font-weight:700}

    /* Liste des créneaux */
    .list{display:grid;gap:10px}
    .empty{font-size:14px;color:var(--muted);opacity:.9;padding:8px}

    .ev{
      display:flex;gap:10px;align-items:stretch;background:var(--card);border:1px solid var(--line);
      border-radius:12px;padding:10px;position:relative;overflow:hidden
    }
    .ev .bar{width:6px;border-radius:8px;background:var(--accent);flex:0 0 6px}
    .ev .info{flex:1;min-width:0}
    .ev .title{font-weight:800;margin-bottom:2px}
    .ev .meta{font-size:13px;color:var(--muted)}
    .ev .meta strong{color:var(--text)}
    .ev .del{position:absolute;top:6px;right:8px;border:none;background:transparent;color:#94a3b8;cursor:pointer;font-size:18px}
    .ev .del:hover{color:#fff}

    /* FAB */
    .fab{
      position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;
      display:grid;place-items:center;background:var(--accent);color:#0b1326;
      border:1px solid #1a2b1f;box-shadow:0 10px 30px rgba(0,0,0,.4);cursor:pointer;z-index:50;
      font-size:28px;line-height:0;font-weight:900
    }

    /* Bottom sheet */
    .sheet-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);
      display:none;align-items:flex-end;z-index:60
    }
    .sheet{
      width:100%;max-width:960px;margin:0 auto;background:var(--card);
      border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);
      border-bottom:none;padding:12px 16px 16px;animation:slideup .18s ease-out;max-height:85vh;overflow:auto
    }
    @keyframes slideup{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}

    .row{display:flex;gap:8px;margin:8px 0;align-items:center}
    .row label{flex:0 0 110px;opacity:.9}
    .row input{flex:1;background:#0b1326;border:1px solid var(--line);border-radius:8px;color:var(--text);padding:10px}

    .sheet .actions{display:flex;gap:8px;margin-top:8px}
    .btn{border:1px solid var(--line);border-radius:10px;background:#0b1326;color:var(--text);padding:8px 12px;cursor:pointer}
    .btn.ghost{background:transparent}
    .subtitle.small{font-size:12px}

    /* Desktop: un peu plus grand */
    @media (min-width:900px){
      h1{font-size:28px}
      .subtitle{font-size:16px}
      .when{font-size:16px;min-width:260px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Retour -->
    <div class="topbar">
      <a href="index.html" class="back">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Retour
      </a>
    </div>

    <!-- Titre -->
    <h1>Planning</h1>
    <div class="subtitle">Vue de la semaine — créneaux d’entraînement</div>

    <!-- Nav semaine -->
    <div class="weekbar">
      <button class="navbtn" id="prev" aria-label="Semaine précédente">‹</button>
      <div class="when" id="when"></div>
      <button class="navbtn" id="today" aria-label="Semaine courante">⌂</button>
      <button class="navbtn" id="next" aria-label="Semaine suivante">›</button>
    </div>

    <!-- Jours -->
    <div class="days" id="days"></div>

    <!-- Liste du jour actif -->
    <div class="list" id="list"></div>

    <!-- Bouton flottant -->
    <button class="fab" id="fab" title="Ajouter">＋</button>

    <!-- Bottom sheet -->
    <div class="sheet-backdrop" id="sheetBg" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="sheet">
        <h3 id="sheetTitle" style="margin:4px 0 8px">Ajouter un créneau</h3>
        <div class="row"><label>Date</label><input id="fDate" type="date"></div>
        <div class="row"><label>Début</label><input id="fStart" placeholder="HH:MM" value="18:00"></div>
        <div class="row"><label>Fin</label><input id="fEnd" placeholder="HH:MM" value="20:00"></div>
        <div class="row"><label>Lieu</label><input id="fLieu" placeholder="Stade / salle"></div>
        <div class="actions">
          <button class="btn ghost" id="cancel">Annuler</button>
          <button class="btn" id="save">Ajouter</button>
        </div>
        <div id="msg" class="subtitle small" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <script>
    const API = 'YOUR_APPS_SCRIPT_URL_HERE'; // <= ton /exec Apps Script
    // Données: id | date(YYYY-MM-DD) | start(HH:MM) | end(HH:MM) | lieu | color
    let ITEMS = [];
    let monday = startOfWeek(new Date());
    let activeDay = 0; // 0..6 (lundi..dimanche)

    // ====== Utils date ======
    function startOfWeek(d){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const wd=(x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function parseYMD(s){ const [Y,M,D]=s.split('-').map(Number); return new Date(Y,M-1,D); }
    function frDayShort(d){ return d.toLocaleDateString('fr-FR',{weekday:'short'}).replace('.',''); }
    function frMonthLong(d){ return d.toLocaleDateString('fr-FR',{month:'long'}); }
    function frRangeLabel(){
      const d0 = addDays(monday,0), d6 = addDays(monday,6);
      const sameMonth = d0.getMonth()===d6.getMonth() && d0.getFullYear()===d6.getFullYear();
      if (sameMonth) return `${d0.getDate()}–${d6.getDate()} ${frMonthLong(d0)} ${d0.getFullYear()}`;
      return `${d0.getDate()} ${frMonthLong(d0)} ${d0.getFullYear()} – ${d6.getDate()} ${frMonthLong(d6)} ${d6.getFullYear()}`;
    }
    function toMin(t){ if(!t) return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }

    // ====== API ======
    async function fetchTrainings(){
      const r = await fetch(API+'?resource=trainings');
      const j = await r.json();
      ITEMS = (j.items||[]).map(x=>({ ...x, color: x.color || '#22c55e' }));
      render();
    }
    async function createTraining(payload){
      const form = new URLSearchParams();
      form.append('resource','trainings'); form.append('action','create'); form.append('item', JSON.stringify(payload));
      const r = await fetch(API, {method:'POST', body:form}); return r.json();
    }
    async function deleteTraining(id){
      const form = new URLSearchParams();
      form.append('resource','trainings'); form.append('action','delete'); form.append('id', id);
      const r = await fetch(API, {method:'POST', body:form}); return r.json();
    }

    // ====== UI build ======
    function buildDays(){
      const days = document.getElementById('days'); days.innerHTML='';
      for(let i=0;i<7;i++){
        const d = addDays(monday,i);
        const btn = document.createElement('button');
        btn.className = 'daypill'+(i===activeDay?' active':'');
        btn.innerHTML = `<div>${frDayShort(d).toUpperCase()}</div><small>${d.getDate()} ${frMonthLong(d)}</small>`;
        btn.onclick = ()=>{ activeDay=i; buildDays(); renderList(); centerActiveDayPill(); };
        days.appendChild(btn);
      }
      document.getElementById('when').textContent = frRangeLabel();
      // mobile: centre la pill du jour actif
      centerActiveDayPill();
    }

    function centerActiveDayPill(){
      const days = document.getElementById('days');
      if (!days) return;
      // Seulement si ça déborde (mobile)
      if (window.innerWidth > 900) return;
      const pills = Array.from(days.children);
      const active = pills[activeDay];
      if (!active) return;
      const offset = active.offsetLeft - (days.clientWidth - active.offsetWidth)/2;
      days.scrollLeft = Math.max(0, offset);
    }

    function renderList(){
      const root = document.getElementById('list');
      root.innerHTML = '';
      const dayDate = ymd(addDays(monday, activeDay));
      const rows = ITEMS.filter(x=>x.date===dayDate).sort((a,b)=> toMin(a.start)-toMin(b.start));
      if (rows.length===0){ root.innerHTML = `<div class="empty">Aucun créneau ce jour.</div>`; return; }
      for(const ev of rows){
        const li = document.createElement('div');
        li.className='ev';
        li.innerHTML = `
          <div class="bar" style="background:${ev.color||'#22c55e'}"></div>
          <div class="info">
            <div class="title">Entraînement</div>
            <div class="meta"><strong>${ev.start || ''}${ev.end? '–'+ev.end : ''}</strong> ${ev.lieu? '• '+ev.lieu : ''}</div>
          </div>
          <button class="del" title="Supprimer">×</button>
        `;
        li.querySelector('.del').onclick = async ()=>{
          if(!confirm('Supprimer ce créneau ?')) return;
          const res = await deleteTraining(ev.id);
          if(res && res.ok){ ITEMS = ITEMS.filter(x=>x.id!==ev.id); renderList(); }
        };
        root.appendChild(li);
      }
    }

    function render(){ buildDays(); renderList(); }

    // ====== Bottom sheet ======
    const sheetBg = document.getElementById('sheetBg');
    function openSheet(prefillDate){
      sheetBg.style.display='flex';
      document.getElementById('fDate').value = prefillDate || ymd(addDays(monday,activeDay));
      document.getElementById('fStart').focus();
    }
    function closeSheet(){ sheetBg.style.display='none'; document.getElementById('msg').textContent=''; }

    // ====== Events ======
    document.getElementById('prev').onclick  = ()=>{ monday=addDays(monday,-7); render(); };
    document.getElementById('next').onclick  = ()=>{ monday=addDays(monday, 7); render(); };
    document.getElementById('today').onclick = ()=>{ monday=startOfWeek(new Date()); activeDay=((new Date().getDay()+6)%7); render(); };

    document.getElementById('fab').onclick   = ()=> openSheet();
    document.getElementById('cancel').onclick= ()=> closeSheet();
    sheetBg.addEventListener('click', (e)=>{ if(e.target===sheetBg) closeSheet(); });

    document.getElementById('save').onclick = async ()=>{
      const date = document.getElementById('fDate').value;
      const start= document.getElementById('fStart').value.trim();
      const end  = document.getElementById('fEnd').value.trim();
      const lieu = document.getElementById('fLieu').value.trim();
      if (!date || !start){ alert('Date et début obligatoires'); return; }
      document.getElementById('msg').textContent = 'Envoi…';
      const res = await createTraining({date,start,end,lieu});
      if(res && res.ok && res.item){
        ITEMS.push(res.item);
        closeSheet();
        renderList();
      }else{
        document.getElementById('msg').textContent='❌ Erreur';
      }
    };

    // ====== Init ======
    (function init(){
      activeDay = (new Date().getDay()+6)%7; // aujourd'hui (lundi=0)
      fetchTrainings();
      render();
    })();
  </script>
</body>
</html>
